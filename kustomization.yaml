apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - litellm/postgres-secret.yaml
  - litellm/postgres-deployment.yaml
  - litellm/postgres-service.yaml
  - litellm/deployment.yaml
  - litellm/service.yaml
  - openwebui/deployment.yaml
  - openwebui/service.yaml
  # Langfuse resources
  - langfuse_web/deployment.yaml
  - langfuse_web/service.yaml
  - langfuse_db/deployment.yaml
  - langfuse_db/service.yaml
  - langfuse_db/postgres-secret.yaml
  - langfuse_worker/deployment.yaml
  - clickhouse/clickhouse-deployment.yaml
  - clickhouse/clickhouse-service.yaml
  - clickhouse/clickhouse-config.yaml
  - clickhouse/clickhouse-secret.yaml
  - redis/redis-deployment.yaml
  - redis/redis-service.yaml
  - minio/minio-deployment.yaml
  - minio/minio-service.yaml
  - minio/minio-secret.yaml


configMapGenerator:
  - name: litellm-config
    files:
      - config.yaml=litellm/config-content.yaml
  - name: langfuse-config
    literals:
      - database-url=postgresql://langfuse:langfuse-password@langfuse-postgres:5432/langfuse
      - db-user=langfuse
      - db-password=langfuse
      - nextauth-url=http://localhost:3000
      - nextauth-secret=1a84e1da06eb3c81219bf989419ad75e2b837eb09a984d23db7465b3fbd7c0e0
      - salt=c340828a0ec29da19f8fb2b2dbdf23ce0a2b7189093442f24f7e92162d8eba81
      - encryption-key=ef0d67d473bae636e0b3de54303c812ba6b54162aa8885d33f4de4d3d507c2c7
      - clickhouse-url=clickhouse://default:langfuse-clickhouse-password@langfuse-clickhouse:9000
      - clickhouse-migration-url=clickhouse://default:langfuse-clickhouse-password@langfuse-clickhouse:9000
      - clickhouse-user=default
      - clickhouse-password=langfuse-clickhouse-password
      - redis-host=langfuse-redis
      - redis-port=6379
      - node-tls-reject-unauthorized=0
      - s3-endpoint=http://minio:9000
      - s3-access-key-id=minioadmin
      - s3-secret-access-key=minioadmin
      - s3-bucket-name=langfuse
      - s3-region=us-east-1
      - s3-force-path-style=true

# Update the deployment to reference the generated ConfigMap name (with hash)
# This ensures the deployment restarts when the ConfigMap changes
replacements:
  - source:
      kind: ConfigMap
      name: litellm-config
      fieldPath: metadata.name
    targets:
      - select:
          kind: Deployment
          name: litellm
        fieldPaths:
          - spec.template.spec.volumes.0.configMap.name

