apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - litellm/postgres-secret.yaml
  - litellm/postgres-deployment.yaml
  - litellm/postgres-service.yaml
  - litellm/deployment.yaml
  - litellm/service.yaml
  - openwebui/deployment.yaml
  - openwebui/service.yaml
  # Langfuse resources
  - langfuse_web/deployment.yaml
  - langfuse_web/service.yaml
  - langfuse_db/deployment.yaml
  - langfuse_db/service.yaml
  - langfuse_db/postgres-secret.yaml
  - langfuse_worker/deployment.yaml
  - clickhouse/clickhouse-deployment.yaml
  - clickhouse/clickhouse-service.yaml
  - clickhouse/clickhouse-config.yaml
  - clickhouse/clickhouse-secret.yaml
  - redis/redis-deployment.yaml
  - redis/redis-service.yaml


configMapGenerator:
  - name: litellm-config
    files:
      - config.yaml=litellm/config-content.yaml
  - name: langfuse-config
    literals:
      - database-url=postgresql://langfuse:langfuse-password@langfuse-postgres:5432/langfuse
      - db-user=langfuse
      - db-password=langfuse
      - nextauth-url=http://localhost:3000
      - nextauth-secret=your-nextauth-secret-change-this-in-production
      - salt=your-salt-change-this-in-production
      - encryption-key=your-encryption-key-change-this-in-production
      - clickhouse-url=clickhouse://default:langfuse-clickhouse-password@langfuse-clickhouse:9000
      - clickhouse-migration-url=clickhouse://default:langfuse-clickhouse-password@langfuse-clickhouse:9000
      - clickhouse-user=default
      - clickhouse-password=langfuse-clickhouse-password
      - redis-host=langfuse-redis
      - redis-port=6379
      - node-tls-reject-unauthorized=0

# Update the deployment to reference the generated ConfigMap name (with hash)
# This ensures the deployment restarts when the ConfigMap changes
replacements:
  - source:
      kind: ConfigMap
      name: litellm-config
      fieldPath: metadata.name
    targets:
      - select:
          kind: Deployment
          name: litellm
        fieldPaths:
          - spec.template.spec.volumes.0.configMap.name

