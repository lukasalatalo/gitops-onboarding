apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - litellm/postgres-secret.yaml
  - litellm/postgres-deployment.yaml
  - litellm/postgres-service.yaml
  - litellm/deployment.yaml
  - litellm/service.yaml
  - openwebui/deployment.yaml
  - openwebui/service.yaml
  # Langfuse resources
  - langfuse_web/deployment.yaml
  - langfuse_web/service.yaml
  - langfuse_db/deployment.yaml
  - langfuse_db/service.yaml
  - langfuse_worker/deployment.yaml
  - clickhouse/deployment.yaml
  - clickhouse/service.yaml
  - clickhouse/configmap.yaml

  # - langfuse/langfuse-secret.yaml
  # - langfuse/postgres-secret.yaml
  # - langfuse/postgres-deployment.yaml
  # - langfuse/postgres-service.yaml
  # - langfuse/clickhouse-secret.yaml
  # - langfuse/clickhouse-config.yaml
  # - langfuse/clickhouse-deployment.yaml
  # - langfuse/clickhouse-service.yaml
  # - langfuse/redis-deployment.yaml
  # - langfuse/redis-service.yaml
  # - langfuse/deployment.yaml
  # - langfuse/service.yaml
  # - langfuse/ingress.yaml

configMapGenerator:
  - name: litellm-config
    files:
      - config.yaml=litellm/config-content.yaml
  - name: langfuse-config
    literals:
      - database-url=postgresql://langfuse:langfuse@langfuse-db-service:5432/langfuse
      - db-user=langfuse
      - db-password=langfuse
      - nextauth-url=http://localhost:3000
      - nextauth-secret=your-nextauth-secret-change-this-in-production
      - salt=your-salt-change-this-in-production
      - encryption-key=your-encryption-key-change-this-in-production
      - clickhouse-url=http://clickhouse-service:8123
      - clickhouse-migration-url=http://clickhouse-service:8123
      - clickhouse-user=langfuse
      - clickhouse-password=langfuse
      - redis-host=redis-service
      - redis-port=6379
      - valkey-password=
      - s3-endpoint=http://minio-service:9000
      - minio-root-user=minioadmin
      - minio-root-password=minioadmin
      - node-tls-reject-unauthorized=0

# Update the deployment to reference the generated ConfigMap name (with hash)
# This ensures the deployment restarts when the ConfigMap changes
replacements:
  - source:
      kind: ConfigMap
      name: litellm-config
      fieldPath: metadata.name
    targets:
      - select:
          kind: Deployment
          name: litellm
        fieldPaths:
          - spec.template.spec.volumes.0.configMap.name

